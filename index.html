<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>iframe Table to CSV</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        iframe { width: 100%; height: 200px; border: 1px solid #ccc; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>

    <h3>1. 対象のiframe</h3>
    <iframe id="target-iframe" srcdoc="
        <table border='1'>
            <tr><th>商品名</th><th>価格</th><th>在庫</th></tr>
            <tr><td>リンゴ</td><td>100</td><td>あり</td></tr>
            <tr><td>バナナ</td><td>150</td><td>なし</td></tr>
            <tr><td>メロン</td><td>2000</td><td>残りわずか</td></tr>
        </table>
    "></iframe>

    <br>
    
    <button id="download-btn">iframeの表をCSVで保存</button>

    <script>
        document.getElementById('download-btn').addEventListener('click', function() {
            // 1. iframeの要素を取得
            const iframe = document.getElementById('target-iframe');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            // 2. iframe内の最初のtableを取得
            const table = iframeDoc.querySelector('table');
            if (!table) {
                alert('iframe内にテーブルが見つかりませんでした。');
                return;
            }

            // 3. テーブルデータを配列に変換
            let csvContent = [];
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = Array.from(cols).map(col => {
                    // カンマや改行が含まれる場合に備えてダブルクォーテーションで囲む
                    let text = col.innerText.replace(/"/g, '""'); 
                    return `"${text}"`;
                });
                csvContent.push(rowData.join(','));
            });

            // 4. CSV文字列を作成（BOM付きでExcelの文字化けを防止）
            const csvString = csvContent.join('\n');
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvString], { type: 'text/csv;charset=utf-8;' });

            // 5. ダウンロード用リンクを作成してクリック
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'table_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>

</body>
</html>
